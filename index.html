<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toko Online Dinamis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Menggunakan font Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Konfigurasi Tailwind untuk tema Hijau dan Mode Gelap */
        :root {
            --primary-green: #059669; /* Emerald 600 */
        }

        /* Styling Dasar */
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* Light Mode (Default) */
        body { background-color: #f0fdf4; color: #1f2937; }
        .card { background-color: #ffffff; }

        /* Dark Mode */
        .dark body { background-color: #1f2937; color: #f9fafb; }
        .dark .card { background-color: #374151; }
        .dark .input-field { background-color: #4b5563; border-color: #6b7280; color: #f9fafb; }
        .dark .text-gray-700 { color: #d1d5db; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary-green': 'var(--primary-green)',
                        'accent-green': '#10b981', /* Emerald 500 */
                    },
                }
            }
        }
    </script>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-6xl mx-auto">
        
        <!-- Header & Dark Mode Toggle -->
        <header class="flex justify-between items-center mb-10 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-primary-green">
                Toko Dinamis
            </h1>
            <div class="flex items-center space-x-4">
                 <!-- Dark Mode Toggle -->
                <button id="themeToggle" onclick="toggleDarkMode()" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 shadow-md">
                    <svg id="sunIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Status Pemuatan -->
        <p id="publicStatus" class="mb-4 text-center text-sm font-medium"></p>


        <!-- Daftar Produk -->
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <p id="loadingMessage" class="lg:col-span-4 text-center text-lg py-12 text-gray-500">
                Memuat produk...
            </p>
        </div>
        
    </div>

    <!-- Modal Pembelian (Order Modal) -->
    <div id="orderModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden" onclick="closeModal(event)">
        <div class="card w-full max-w-md rounded-xl p-6 shadow-2xl transition-all duration-300 transform scale-100" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-4 border-b pb-2 text-primary-green" id="modalTitle">Checkout Pesanan</h2>
            
            <div id="modalProductDetails" class="mb-4 bg-primary-green/10 p-3 rounded-lg border border-primary-green/30">
                <!-- Detail produk yang dibeli akan dimasukkan di sini -->
            </div>

            <div id="checkoutForm">
                <h3 class="font-semibold mb-3 text-gray-700 dark:text-gray-300">Data Pengirim & Pembayaran DANA</h3>
                <div class="space-y-3">
                    <div>
                        <label for="senderName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nama Pengirim DANA</label>
                        <input type="text" id="senderName" class="input-field mt-1 block w-full rounded-md shadow-sm p-2 border">
                    </div>
                    <div>
                        <label for="personalEmail" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Pribadi</label>
                        <input type="email" id="personalEmail" class="input-field mt-1 block w-full rounded-md shadow-sm p-2 border">
                    </div>
                </div>
                
                <button onclick="submitOrder()" class="mt-6 w-full bg-primary-green text-white font-semibold py-3 rounded-lg hover:bg-emerald-700 transition duration-150" id="submitButton">
                    Konfirmasi Pesanan
                </button>
            </div>

            <div id="paymentSuccess" class="hidden">
                <h3 class="text-xl font-bold text-center text-green-600 mb-4">âœ… Pesanan Berhasil Direkam!</h3>
                <p class="text-sm text-gray-700 dark:text-gray-300 mb-4">
                    Pesanan Anda telah dicatat di sistem. Harap lakukan transfer ke rekening DANA di bawah ini. Admin akan mengubah status pesanan Anda setelah pembayaran diterima.
                </p>
                <div class="bg-yellow-100 dark:bg-yellow-900 p-4 rounded-lg mb-6 border border-yellow-300 text-center">
                    <p class="font-bold text-xl text-yellow-800 dark:text-yellow-200">DANA: 081574769589</p>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300">Atas Nama: Nenih</p>
                </div>
                <p class="text-center text-xs text-gray-500 dark:text-gray-400">Anda dapat menutup jendela ini.</p>
            </div>
            
            <button onclick="hideModal()" class="mt-4 w-full text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">
                Tutup
            </button>
        </div>
    </div>

    <script>
        // =====================================================================================
        // !!! PERHATIAN: GANTI NILAI PLACEHOLDER DI BAWAH INI DENGAN BIN ID & MASTER KEY ANDA !!!
        // Master Key dibutuhkan di sini untuk men-save data order baru.
        // =====================================================================================
        const PUBLIC_BIN_ID = "68f08ef8ae596e708f1668a6"; 
        const MASTER_KEY_FOR_ORDERS = "$2a$10$RrK3Tfyj9sFc1HEUXuTgmOa45uOdTGHwXOb6cDC9Kn.YO.Sca0hkW"; // Diperlukan untuk PUSH data order baru
        // =====================================================================================

        // --- Konfigurasi dan State ---
        const PUBLIC_API_URL = 'https://api.jsonbin.io/v3/b/';
        const NENIH_PHONE = '6281574769589'; // No DANA
        let currentProduct = null;
        let appData = {};

        // --- Dark Mode Logic ---

        /**
         * Menginisialisasi Mode Gelap berdasarkan preferensi browser atau localStorage.
         */
        function initializeDarkMode() {
            const isDark = localStorage.getItem('theme') === 'dark' || 
                           (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            
            if (isDark) {
                document.documentElement.classList.add('dark');
                document.getElementById('moonIcon').classList.remove('hidden');
                document.getElementById('sunIcon').classList.add('hidden');
            } else {
                 document.getElementById('sunIcon').classList.remove('hidden');
                 document.getElementById('moonIcon').classList.add('hidden');
            }
        }

        /**
         * Mengubah mode terang/gelap dan menyimpan preferensi.
         */
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            
            document.getElementById('sunIcon').classList.toggle('hidden', isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDark);
        }

        // --- Fungsi Status dan Data Fetching ---

        /**
         * Menampilkan pesan status di UI
         */
        function updateStatus(message, type) {
            const statusMessage = document.getElementById('publicStatus');
            statusMessage.textContent = message;
            statusMessage.className = 'mb-4 text-center text-sm font-medium'; 

            if (type === 'success') {
                statusMessage.classList.add('text-green-600');
            } else if (type === 'error') {
                statusMessage.classList.add('text-red-600');
            } else if (type === 'loading') {
                statusMessage.classList.add('text-primary-green');
            }
        }

        /**
         * Mengambil dan menampilkan konten (hanya produk) dari jsonbin.io
         */
        async function loadContent() {
            const loadingMessage = document.getElementById('loadingMessage');
            
            if (PUBLIC_BIN_ID === "MASUKKAN_BIN_ID_ANDA_DI_SINI" || !PUBLIC_BIN_ID) {
                loadingMessage.textContent = 'Gagal memuat: Harap masukkan BIN ID Anda di kode JavaScript.';
                updateStatus('Kesalahan: BIN ID belum dikonfigurasi.', 'error');
                return;
            }

            updateStatus('Memuat konten...', 'loading');
            loadingMessage.textContent = 'Sedang mengambil data produk...';

            try {
                // Untuk toko, kita hanya perlu Bin ID (tanpa Master Key) untuk GET data produk
                const response = await fetch(`${PUBLIC_API_URL}${PUBLIC_BIN_ID}/latest`, {
                    method: 'GET',
                    headers: { 'X-Bin-Meta-Data': 'false' }
                });

                if (!response.ok) {
                    throw new Error(`Gagal memuat: ${response.status}. Pastikan Bin ID valid.`);
                }

                const data = await response.json();
                
                if (data.products && Array.isArray(data.products)) {
                    // Hanya simpan struktur yang valid
                    appData = { products: data.products, orders: data.orders || [] }; 
                    renderProducts(appData.products);
                    updateStatus('Produk berhasil dimuat!', 'success');
                } else {
                    throw new Error('Struktur data produk tidak valid. Harap periksa di Admin Panel.');
                }
                
            } catch (error) {
                console.error("Kesalahan saat memuat konten:", error);
                loadingMessage.textContent = `Gagal memuat produk. Error: ${error.message}`;
                document.getElementById('productsGrid').innerHTML = '';
                updateStatus(`Kesalahan: ${error.message}`, 'error');
            }
        }

        /**
         * Merender kartu produk ke UI
         */
        function renderProducts(products) {
            const grid = document.getElementById('productsGrid');
            grid.innerHTML = '';

            if (products.length === 0) {
                grid.innerHTML = '<p class="lg:col-span-4 text-center text-xl py-12 text-gray-500">Saat ini tidak ada produk yang tersedia.</p>';
                return;
            }

            products.forEach(product => {
                const imageUrl = product.photoLink || 'https://placehold.co/400x300/e5e7eb/4b5563?text=No+Image';
                
                const productCard = document.createElement('div');
                productCard.className = 'card rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden transform hover:scale-[1.02] border border-gray-100 dark:border-gray-600';
                productCard.innerHTML = `
                    <div class="h-48 overflow-hidden">
                        <img src="${imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e5e7eb/4b5563?text=Produk+Tanpa+Foto';" alt="${product.name}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-5">
                        <h3 class="text-xl font-bold mb-2 text-gray-800 dark:text-gray-100">${product.name}</h3>
                        <p class="text-2xl font-extrabold text-primary-green mb-4">${product.price}</p>
                        <button onclick="showModal('${product.id}')" class="w-full bg-primary-green text-white font-bold py-3 rounded-lg hover:bg-emerald-700 transition duration-150 shadow-md shadow-primary-green/50">
                            Beli Sekarang
                        </button>
                    </div>
                `;
                grid.appendChild(productCard);
            });
        }

        // --- Fungsi Modal Pembelian & Order Submission ---

        /**
         * Menampilkan modal pembelian
         */
        function showModal(productId) {
            const product = appData.products.find(p => p.id === productId);
            if (!product) return;
            
            currentProduct = product;
            
            // Reset modal state
            document.getElementById('modalTitle').textContent = 'Checkout Pesanan';
            document.getElementById('checkoutForm').classList.remove('hidden');
            document.getElementById('paymentSuccess').classList.add('hidden');
            document.getElementById('senderName').value = localStorage.getItem('last_senderName') || '';
            document.getElementById('personalEmail').value = localStorage.getItem('last_personalEmail') || '';
            document.getElementById('submitButton').disabled = false;
            document.getElementById('submitButton').textContent = 'Konfirmasi Pesanan';


            document.getElementById('modalProductDetails').innerHTML = `
                <p class="text-lg font-bold text-gray-800 dark:text-gray-100">${product.name}</p>
                <p class="text-xl font-extrabold text-primary-green">${product.price}</p>
            `;
            
            document.getElementById('orderModal').classList.remove('hidden');
        }

        /**
         * Menyembunyikan modal
         */
        function hideModal() {
            document.getElementById('orderModal').classList.add('hidden');
            currentProduct = null;
        }

        /**
         * Menyembunyikan modal ketika klik di luar konten
         */
        function closeModal(event) {
            if (event.target.id === 'orderModal') {
                hideModal();
            }
        }

        /**
         * Mengambil data terbaru, menambahkan pesanan baru, dan menyimpan (PUT)
         */
        async function submitOrder() {
            const senderName = document.getElementById('senderName').value.trim();
            const personalEmail = document.getElementById('personalEmail').value.trim();
            const submitButton = document.getElementById('submitButton');
            
            if (!senderName || !personalEmail || !MASTER_KEY_FOR_ORDERS || MASTER_KEY_FOR_ORDERS === "MASUKKAN_MASTER_KEY_ANDA_DI_SINI") {
                alert('Harap isi Nama Pengirim DANA dan Email Pribadi, serta pastikan MASTER_KEY sudah dikonfigurasi di kode HTML.');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Memproses...';

            // Simpan data di local storage untuk pengisian otomatis berikutnya
            localStorage.setItem('last_senderName', senderName);
            localStorage.setItem('last_personalEmail', personalEmail);

            try {
                // 1. GET data terbaru untuk menghindari konflik overwrite
                const getResponse = await fetch(`${PUBLIC_API_URL}${PUBLIC_BIN_ID}/latest`, {
                    method: 'GET',
                    headers: { 
                        'X-Bin-Meta-Data': 'false' 
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`Gagal mengambil data terbaru: ${getResponse.statusText}`);
                }
                let currentData = await getResponse.json();
                
                // Pastikan orders adalah array
                if (!currentData.orders || !Array.isArray(currentData.orders)) {
                    currentData.orders = [];
                }
                
                // 2. Buat objek pesanan baru
                const newOrder = {
                    id: Date.now().toString(36) + Math.random().toString(36).substring(2, 6),
                    timestamp: new Date().toISOString(),
                    productId: currentProduct.id,
                    productName: currentProduct.name,
                    productPrice: currentProduct.price,
                    senderName: senderName,
                    email: personalEmail,
                    status: 'Pending' // Status awal
                };

                // 3. Tambahkan pesanan ke array dan batasi jumlah pesanan (misal 50)
                currentData.orders.unshift(newOrder); 
                currentData.orders = currentData.orders.slice(0, 50); // Agar bin tidak terlalu besar

                // 4. PUT (Save) data yang diperbarui
                const putResponse = await fetch(`${PUBLIC_API_URL}${PUBLIC_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': MASTER_KEY_FOR_ORDERS,
                        'X-Bin-Meta-Data': 'false'
                    },
                    body: JSON.stringify(currentData)
                });

                if (!putResponse.ok) {
                    throw new Error(`Gagal menyimpan pesanan: ${putResponse.statusText}`);
                }

                // Sukses: Tampilkan pesan pembayaran
                document.getElementById('modalTitle').textContent = 'Pembayaran DANA';
                document.getElementById('checkoutForm').classList.add('hidden');
                document.getElementById('paymentSuccess').classList.remove('hidden');

            } catch (error) {
                console.error("Kesalahan dalam proses pemesanan:", error);
                alert(`Gagal memproses pesanan: ${error.message}. Pastikan Master Key dan Bin ID sudah benar.`);
                submitButton.textContent = 'Gagal, Coba Lagi';
                submitButton.disabled = false;
            }
        }

        // --- Inisialisasi Aplikasi ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            loadContent(); 
        });
    </script>
</body>
</html>

  
